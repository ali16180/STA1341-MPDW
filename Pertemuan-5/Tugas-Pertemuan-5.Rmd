---
title: "Handling Non-Stationary Data (Rataan & Ragam)"
author: "Muhammad Hafiz Fazli"
date: "`r Sys.Date()`"
output:
  html_document:
    theme:
      version: 4
      bg: "#2D2A2E"  # Monokai soft dark gray background
      fg: "#E3E3E3"  # Soft light gray text
      primary: "#A6E22E"  # Monokai green for highlights (links, buttons)
      secondary: "#FD971F"  # Monokai orange for secondary elements
      base_font: {google: "Fira Code"}  # Monospace font for clean look
    toc: true
    toc_float: true
    number_sections: false
    code_folding: show
    highlight: espresso  # Works best with dark backgrounds
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup Environment

## Import Dependencies

```{r}
library(readr)
library(tsibble)
library(ggplot2)
library(tseries)
library(lattice)
library(MASS)
```

## Load Data

```{r}
df <- read_csv("C:/Users/Muhammad Hafiz F/Downloads/Telur Ayam Ras_Nov23-Apr24.csv")

names(df)[names(df) == "Jawa Barat"] <- "Harga"

df
```

## Train-Test Split

```{r}
n <- nrow(df)
n_train <- floor(0.8 * n)

train <- df[1:n_train, ]
test  <- df[(n_train+1):n, ]

dim(train)
dim(test)

train
test
```

# Cek Stasioneritas dalam Rataan

## Plot Time Series

```{r}
ts <- train$Harga

ts_tbl <- tibble(
  index = 1:length(ts),
  value = ts
)

plot_ts <- ts_tbl |> 
  as_tsibble(index = index) |> 
  ggplot(aes(x = index, y = value)) + 
  geom_line() + theme_bw() +
  xlab("Obs") + ylab("Nilai")

plot_ts
```

**Interpretasi:** 

> Plot deret waktu di atas menunjukkan bahwa data belum stasioner dalam rataan, ditandai dengan adanya tren meningkat dan menurun yang cukup jelas, sehingga nilai tidak menyebar secara konsisten di sekitar satu titik tengah.

## Plot ACF

```{r}
acf(ts)
```

**Interpretasi:** 

> Berdasarkan plot ACF, terlihat bahwa nilai autokorelasi sangat tinggi pada lag awal dan menurun secara perlahan (tails off). Pola ini menunjukkan bahwa data memiliki tren kuat dan belum stasioner.


## Uji Augmented Dickey-Fuller (ADF)

```{r}
tseries::adf.test(ts)
```

**Interpretasi:** 

> Berdasarkan uji ADF, diperoleh p-value sebesar 0.99 yang lebih besar dari taraf nyata 5%. Dengan demikian, gagal menolak hipotesis nol sehingga data tidak stasioner dalam rataan. Hal ini konsisten dengan hasil eksplorasi menggunakan plot deret waktu yang menunjukkan adanya tren, serta plot ACF yang tidak cepat turun ke nol.

# Cek Stasioneritas dalam Ragam
## Plot Box-Cox
```{r}
index <- seq_along(ts)

bc <- boxcox(
  ts ~ index,
  lambda = seq(-1, 4, by = 0.01)
)

lambda <- bc$x[which.max(bc$y)]
lambda

ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

**Interpretasi:** 

> Gambar di atas menunjukkan nilai lambda optimum (dibulatkan) sebesar -1 dan selang kepercayaan 95% berada pada batas bawah -1,00 dan batas atas -0,42. Karena selang tersebut tidak memuat nilai satu, maka dapat dikatakan bahwa data tidak stasioner dalam ragam.


# Handling Non-Stationary Data (Rataan & Ragam)
## Differencing
```{r}
ts_diff1 <- diff(ts, differences = 1)

tseries::adf.test(ts_diff1)

epsilon <- 1e-6
ts_diff1_pos <- ts_diff1 - min(ts_diff1) + epsilon

index <- seq_along(ts_diff1_pos)

bc <- boxcox(
  lm(ts_diff1_pos ~ index),
  lambda = seq(-1, 4, by = 0.01)
)

lambda <- bc$x[which.max(bc$y)]
lambda

ci_lambda <- bc$x[bc$y > max(bc$y) - 0.5 * qchisq(0.95, 1)]

ci_lower <- min(ci_lambda)
ci_upper <- max(ci_lambda)

c(Batas_Bawah = ci_lower, Batas_Atas = ci_upper)
```

**Interpretasi:**

> Berdasarkan uji ADF setelah differencing, diperoleh p-value sebesar 0.01307 yang lebih kecil dari taraf nyata 5%. Dengan demikian, tolak hipotesis nol sehingga data stasioner dalam rataan.
Plot Box-Cox di atas menunjukkan nilai lambda optimum (dibulatkan) sebesar 0,74 dan selang kepercayaan 95% berada pada batas bawah 0,57 dan batas atas 0,94. Karena selang tersebut tidak memuat nilai satu, maka dapat dikatakan bahwa data tidak stasioner dalam ragam dan transformasi lebih lanjut diperlukan untuk menstabilkan varians.

## Box-Cox Transformation
```{r}
boxcox_transform <- function(x, lam) {
  if (abs(lam) < 1e-8) log(x) else (x^lam - 1) / lam
}

ts_diff1_bc <- boxcox_transform(ts_diff1_pos, lambda)
```

## Shift Back to Original Scale
```{r}
shift_val <- -min(ts_diff1) + epsilon

ts_diff1_bc_back <- ts_diff1_bc - shift_val

summary(ts_diff1_bc_back)
```

**Kesimpulan:**

> Setelah dilakukan differencing dan transformasi Boxâ€“Cox, data kini stasioner baik dalam rataan maupun ragam.